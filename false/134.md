0xPkhatri

high

# Predictable Salt in MarginTradingFactory#createMarginTrading Leads to Potential DoS the system

## Summary

The predictable nature of the salt used in MarginTradingFactory#createMarginTrading function while cloning margintrading could potentially allow a malicious actor to predeploy a contract at the expected address, causing the create2 opcode to fail and effectively leading to a DoS.

## Vulnerability Detail

In the createMarginTrading function, a salt is used to create a deterministic clone of the MARGIN_TRADING_TEMPLATE contract. The salt is generated by hashing the concatenation of msg.sender, crossMarginTrading[msg.sender].length (or isolatedMarginTrading[msg.sender].length), and _flag. As these values are predictable, a malicious actor who can accurately predict the salt could predeploy a contract at the expected address, causing the create2 opcode to fail.

## Impact

It could prevent the legitimate creation of new margin trading contracts, effectively leading to a Denial of Service (DoS) attack. This could disrupt the normal functioning of the contract.

## Code Snippet

https://github.com/sherlock-audit/2023-05-dodo/blob/main/dodo-margin-trading-contracts/contracts/marginTrading/MarginTradingFactory.sol#L115-L135

## Tool used

Manual Review

## Recommendation

To mitigate this vulnerability, consider incorporating a value that's difficult to predict into the salt. This could be the blockhash of a recent block, or a securely generated random number. Here's an example:

```solidity
bytes32 salt = keccak256(abi.encodePacked(msg.sender, crossMarginTrading[msg.sender].length, _flag, blockhash(block.number - 1)));

```
even you can use block.timestamp, block.prevrandao for batter pseudo-random salt.